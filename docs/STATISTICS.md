# Документация: Статистика учеников

## 1. Активные ученики

**Источник:** `getActiveStudentStatistics()` в `src/actions/students.ts`  
**Данные:** таблица `StudentGroup` с join на `Group`, `Course`, `Location`, `Teacher`, `Student`

### KPI-метрики

| Метрика             | Поле            | Формула                                                                                                               |
| ------------------- | --------------- | --------------------------------------------------------------------------------------------------------------------- |
| Всего активных      | `totalStudents` | Количество уникальных студентов в `StudentGroup` (дедупликация по `student.id`)                                       |
| Новых в этом месяце | `newThisMonth`  | Число уникальных студентов с `student.createdAt` в текущем календарном месяце                                         |
| Рост (%)            | `growthPercent` | `((newThisMonth - newPrevMonth) / newPrevMonth) * 100`, округление до целого. Если в прошлом месяце 0 → показывает 0% |
| Групп               | `totalGroups`   | Число уникальных `groupId` в `StudentGroup`                                                                           |
| Среднее на группу   | `avgPerGroup`   | `totalStudents / totalGroups`, округление до 1 знака                                                                  |

### Графики

| График            | Тип        | Описание                                                                                                                                                                   |
| ----------------- | ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Динамика набора   | Area chart | Количество новых уникальных студентов по месяцу их `createdAt`. Сортировка хронологическая (по timestamp). Формат оси X: `"янв. 26"`                                       |
| По курсам         | Bar list   | Топ-5 курсов по числу уникальных студентов. Студент считается в курсе, если состоит в группе этого курса                                                                   |
| По преподавателям | Bar list   | Топ-5 преподавателей. Студент считается у преподавателя, если состоит в группе, к которой привязан этот преподаватель. Один студент может быть у нескольких преподавателей |
| По локациям       | Bar list   | Топ-5 локаций. Аналогично - уникальные студенты через `Set<studentId>`                                                                                                     |

### Особенности подсчёта

- Студент, состоящий в нескольких группах, учитывается **один раз** в `totalStudents`, но может быть посчитан у **нескольких** преподавателей/курсов/локаций
- Месяц определяется по дате создания записи студента (`student.createdAt`), а не по дате зачисления в группу

---

## 2. Пропустившие ученики (Пропуски)

**Источник:** `getAbsentStatistics()` в `src/actions/attendance.ts`  
**Данные:** таблица `Attendance` (status = `ABSENT`) с join на `Student`, `Lesson`, `MissedMakeup`

### KPI-метрики

| Метрика         | Поле              | Формула                                                                                                                   |
| --------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------- |
| Всего пропусков | `totalAbsences`   | Общее число записей `Attendance` со статусом `ABSENT`                                                                     |
| Отработано      | `totalSaved`      | Число пропусков, у которых `missedMakeup.makeUpAttendance.status === 'PRESENT'` (отработка назначена и ученик пришёл)     |
| % отработок     | `makeupRate`      | `(totalSaved / totalAbsences) * 100`, округление до 1 десятичного знака                                                   |
| Средняя ставка  | `averagePrice`    | Глобальная: `SUM(payment.price) / SUM(payment.lessonCount)` по всем оплатам организации с `lessonCount > 0` и `price > 0` |
| Потери (₽)      | `totalLostMoney`  | `SUM(missedMoney - savedMoney)` по всем месяцам - деньги за неотработанные пропуски                                       |
| Возвращено (₽)  | `totalSavedMoney` | `SUM(savedMoney)` по всем месяцам - деньги, которые «спасли» через отработки                                              |

### Расчёт стоимости пропуска

Для каждого пропуска определяется индивидуальная ставка ученика:

```
rate = student.totalPayments / student.totalLessons
```

Если у ученика нет данных → используется глобальная `averagePrice`.

### Графики

| График                | Тип                  | Описание                                                                                     |
| --------------------- | -------------------- | -------------------------------------------------------------------------------------------- |
| Пропуски vs отработки | Area chart (2 линии) | Красная - пропущено, зелёная - отработано. Переключение: кол-во / деньги (₽), месяц / неделя |

### Режимы отображения

- **Кол-во**: `missed` (все пропуски) и `saved` (успешные отработки)
- **Деньги**: `missedMoney` (сумма ставок всех пропусков) и `savedMoney` (сумма ставок отработанных)
- **По месяцам**: группировка по `YYYY-MM`, отображение `"янв. 26"`
- **По неделям**: группировка по понедельнику недели, отображение `"17.02"`

### Что считается «отработанным»

Пропуск считается отработанным (`saved`), **только если**:

1. Для пропуска создана запись `MissedMakeup`
2. У неё есть `makeUpAttendance` (урок-отработка)
3. Статус отработки = `PRESENT` (ученик реально пришёл)

---

## 3. Отчисленные ученики

**Источник:** `getDismissedStatistics()` в `src/actions/dismissed.ts`  
**Данные:** таблица `Dismissed` с join на `Group`, `Course`, `Location`, `Teacher`, `Student` + отдельный запрос `StudentGroup.count` и `TeacherGroup`

### KPI-метрики

| Метрика           | Поле             | Формула                                                                                                                                    |
| ----------------- | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| Всего отчислено   | `totalDismissed` | `dismissed.length` - общее число записей в `Dismissed`                                                                                     |
| Churn rate        | `churnRate`      | `totalDismissed / (activeCount + totalDismissed) * 100`, округление до 1 десятичного знака. `activeCount` = число записей в `StudentGroup` |
| В этом месяце     | `thisMonthCount` | Число отчислений с `dismissed.date` в текущем месяце                                                                                       |
| Тренд             | `monthDelta`     | `thisMonthCount - prevMonthCount`. Зелёный если **уменьшились** (инверсия - меньше отчислений = лучше)                                     |
| Самый частый курс | `topCourseName`  | Курс с максимальным числом отчислений                                                                                                      |

### Графики

| График                       | Тип        | Описание                                                                                                                            |
| ---------------------------- | ---------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| Отток по месяцам             | Area chart | Число отчислений по месяцу `dismissed.date`. Хронологическая сортировка                                                             |
| По преподавателям (% оттока) | Bar list   | Топ-5 преподавателей. Процент: `dismissedCount / (activeStudents + dismissedCount) * 100`. Показывает и процент, и абсолютное число |
| По курсам                    | Bar list   | Топ-5 курсов по числу отчислений                                                                                                    |
| По локациям                  | Bar list   | Топ-5 локаций по числу отчислений                                                                                                   |

### Формула churn rate по преподавателю

```
percentage = dismissedCount / (totalStudents + dismissedCount) * 100
```

Где:

- `dismissedCount` - число отчисленных из групп этого преподавателя
- `totalStudents` - число **текущих активных** студентов в группах преподавателя (`TeacherGroup → Group._count.students`)

Это даёт процент оттока от **всех когда-либо бывших** (активные + ушедшие).

---

## Структура файлов

```
src/actions/
  students.ts     → getActiveStudentStatistics()
  attendance.ts   → getAbsentStatistics()
  dismissed.ts    → getDismissedStatistics()

src/app/s/[slug]/dashboard/students/
  active/statistics/active-statistics.tsx      - KPI + area chart + bar lists
  absent/statistics/absent-statistics.tsx      - KPI + area chart с переключением
  dismissed/statistics/dismissed-statistics.tsx - KPI + area chart + bar lists
```
