generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

// Better-auth models

model User {
  id Int @id @default(autoincrement())

  // better-auth fields
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  role          String?
  banned        Boolean?  @default(false)
  banReason     String?
  banExpires    DateTime?

  groups                TeacherGroup[]
  lessons               TeacherLesson[]
  payChecks             PayCheck[]
  lessonsBalanceChanges StudentLessonsBalanceHistory[]
  sessions              Session[]
  accounts              Account[]
  members               Member[]
  invitations           Invitation[]

  @@unique([email])
  @@map("User")
}

model Session {
  id                   Int      @id @default(autoincrement())
  expiresAt            DateTime
  token                String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  ipAddress            String?
  userAgent            String?
  userId               Int
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  impersonatedBy       String?
  activeOrganizationId String?

  @@unique([token])
  @@index([userId])
  @@map("Session")
}

model Account {
  id                    Int       @id @default(autoincrement())
  accountId             String
  providerId            String
  userId                Int
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("Account")
}

model Verification {
  id         Int      @id @default(autoincrement())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("Verification")
}

model Organization {
  id                             Int                            @id @default(autoincrement())
  name                           String
  slug                           String
  logo                           String?
  createdAt                      DateTime                       @default(now())
  updatedAt                      DateTime                       @updatedAt
  metadata                       String?
  members                        Member[]
  invitations                    Invitation[]
  rates                          Rate[]
  groupTypes                     GroupType[]
  courses                        Course[]
  locations                      Location[]
  students                       Student[]
  groups                         Group[]
  payChecks                      PayCheck[]
  studentGroups                  StudentGroup[]
  dismisseds                     Dismissed[]
  teacherGroups                  TeacherGroup[]
  teacherLessons                 TeacherLesson[]
  lessons                        Lesson[]
  attendances                    Attendance[]
  makeUps                        MakeUp[]
  payments                       Payment[]
  unprocessedPayments            UnprocessedPayment[]
  carts                          Cart[]
  cartItems                      CartItem[]
  categories                     Category[]
  products                       Product[]
  orders                         Order[]
  paymentProducts                PaymentProduct[]
  studentLessonsBalanceHistories StudentLessonsBalanceHistory[]
  groupSchedules                 GroupSchedule[]

  @@unique([slug])
  @@map("Organization")
}

model Member {
  id             Int          @id @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         Int
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("teacher")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@map("Member")
}

model Invitation {
  id             Int          @id @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  inviterId      Int
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("Invitation")
}

// 

// Business models

model PayCheck {
  id        Int      @id @default(autoincrement())
  amount    Int
  comment   String
  date      DateTime @db.Date
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId Int
  userId         Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([organizationId])
}

model Student {
  id             Int      @id @default(autoincrement())
  firstName      String
  lastName       String
  login          String
  password       String
  age            Int
  birthDate      DateTime @db.Date
  parentsName    String?
  parentsPhone   String?
  url            String?
  coins          Int      @default(0)
  lessonsBalance Int      @default(0)
  totalLessons   Int      @default(0)
  totalPayments  Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  cart                  Cart?
  attendances           Attendance[]
  orders                Order[]
  payments              Payment[]
  groups                StudentGroup[]
  unprocessedPayments   UnprocessedPayment[]
  dismisseds            Dismissed[]
  lessonsBalanceHistory StudentLessonsBalanceHistory[]

  @@index([organizationId])
}

model Group {
  id          Int      @id @default(autoincrement())
  startDate   DateTime @db.Date
  dayOfWeek   Int
  time        String
  maxStudents Int
  url         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  organizationId Int
  courseId        Int
  locationId     Int
  groupTypeId    Int?
  location       Location     @relation(fields: [locationId], references: [id], onDelete: Cascade)
  course         Course       @relation(fields: [courseId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  groupType      GroupType?   @relation(fields: [groupTypeId], references: [id])

  lessons               Lesson[]
  students              StudentGroup[]
  teachers              TeacherGroup[]
  dismisseds            Dismissed[]
  schedules             GroupSchedule[]
  payments              Payment[]
  balanceHistoryEntries StudentLessonsBalanceHistory[]

  @@index([organizationId])
  @@index([courseId])
  @@index([locationId])
  @@index([groupTypeId])
}

model GroupSchedule {
  id        Int      @id @default(autoincrement())
  dayOfWeek Int
  time      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId Int
  groupId        Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  group          Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, dayOfWeek])
  @@index([groupId])
  @@index([organizationId])
}

model Location {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  groups Group[]

  @@index([organizationId])
}

model Course {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  groups Group[]

  @@index([organizationId])
}

model Lesson {
  id        Int          @id @default(autoincrement())
  date      DateTime     @db.Date
  time      String
  status    LessonStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  organizationId Int
  groupId        Int
  group          Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  attendance Attendance[]
  teachers   TeacherLesson[]

  @@index([groupId])
  @@index([organizationId])
  @@index([date])
}

model StudentLessonsBalanceHistory {
  id             Int                               @id @default(autoincrement())
  studentId      Int
  organizationId Int
  actorUserId    Int?
  groupId        Int?
  field          StudentFinancialField             @default(LESSONS_BALANCE)
  reason         StudentLessonsBalanceChangeReason
  delta          Int
  balanceBefore  Int
  balanceAfter   Int
  comment        String?
  meta           Json?
  createdAt      DateTime                          @default(now())
  updatedAt      DateTime                          @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  actorUser    User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)
  group        Group?       @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@index([studentId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([organizationId])
  @@index([groupId])
}

// 

// Relation models

model StudentGroup {
  status         StudentStatus
  lessonsBalance Int           @default(0)
  totalLessons   Int           @default(0)
  totalPayments  Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organizationId Int
  studentId      Int
  groupId        Int
  group          Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@id([studentId, groupId])
  @@index([groupId])
  @@index([organizationId])
}

model Dismissed {
  id        Int      @id @default(autoincrement())
  comment   String
  date      DateTime @db.Date
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId Int
  studentId      Int
  groupId        Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  group          Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([groupId])
  @@index([organizationId])
}

model Rate {
  id              Int      @id @default(autoincrement())
  name            String
  bid             Int
  bonusPerStudent Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teacherGroups  TeacherGroup[]
  groupTypes     GroupType[]

  @@index([organizationId])
}

model GroupType {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId Int
  rateId         Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rate           Rate         @relation(fields: [rateId], references: [id])

  groups Group[]

  @@index([organizationId])
  @@index([rateId])
}

model TeacherGroup {
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId Int
  groupId        Int
  teacherId      Int
  rateId         Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  group          Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  teacher        User         @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  rate           Rate         @relation(fields: [rateId], references: [id])

  @@id([teacherId, groupId])
  @@index([groupId])
  @@index([organizationId])
  @@index([rateId])
}

model TeacherLesson {
  bid             Int
  bonusPerStudent Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organizationId Int
  lessonId       Int
  teacherId      Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lesson         Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  teacher        User         @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@id([teacherId, lessonId])
  @@index([lessonId])
  @@index([organizationId])
}

model Attendance {
  id            Int              @id @default(autoincrement())
  status        AttendanceStatus @default(UNSPECIFIED)
  comment       String           @default("")
  isWarned      Boolean?
  studentStatus StudentStatus    @default(ACTIVE)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  organizationId Int
  lessonId       Int
  studentId      Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lesson         Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  asMakeupFor  MakeUp? @relation("MakeUpAttendance")
  missedMakeup MakeUp? @relation("MissedAttendance")

  @@unique([studentId, lessonId])
  @@index([lessonId])
  @@index([organizationId])
}

// 

// TODO: This model is a bit weird, consider refactoring it in the future. It currently serves the purpose of linking a missed attendance with its makeup attendance, but it might be better to have a more explicit relation or even merge it with Attendance model with some nullable fields.
model MakeUp {
  id                 Int @id @default(autoincrement())
  organizationId     Int @default(1)
  missedAttendanceId Int @unique
  makeUpAttendanceId Int @unique @map("makeUpAttendaceId")

  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  makeUpAttendance Attendance   @relation("MakeUpAttendance", fields: [makeUpAttendanceId], references: [id], onDelete: Cascade)
  missedAttendance Attendance   @relation("MissedAttendance", fields: [missedAttendanceId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Payment {
  id           Int      @id @default(autoincrement())
  lessonCount  Int      @default(0)
  price        Int      @default(0)
  bidForLesson Int      @default(0)
  leadName     String   @default("")
  productName  String   @default("")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  organizationId Int
  studentId      Int
  groupId        Int?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student      @relation(fields: [studentId], references: [id])
  group          Group?       @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@index([studentId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([groupId])
}

model UnprocessedPayment {
  id        Int      @id @default(autoincrement())
  rawData   Json?
  reason    String
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId Int
  studentId      Int?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student        Student?     @relation(fields: [studentId], references: [id])

  @@index([organizationId])
  @@index([studentId])
}

model PaymentProduct {
  id          Int    @id @default(autoincrement())
  name        String
  productId   Int?
  price       Int
  lessonCount Int

  // Relations
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Shop related models. They are currently quite basic, but they can be expanded in the future with more features like discounts, product variants, etc.
model Cart {
  id             Int          @id @default(autoincrement())
  organizationId Int          @default(1)
  studentId      Int          @unique
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  CartItem       CartItem[]

  @@index([organizationId])
}

model CartItem {
  id             Int          @id @default(autoincrement())
  organizationId Int          @default(1)
  cartId         Int
  productId      Int
  quantity       Int
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Cart           Cart         @relation(fields: [cartId], references: [id], onDelete: Cascade)
  Product        Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
}

model Category {
  id             Int    @id @default(autoincrement())
  organizationId Int
  name           String

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Product      Product[]

  @@index([organizationId])
}

model Product {
  id             Int        @id @default(autoincrement())
  organizationId Int        @default(1)
  name           String
  description    String?
  price          Int
  originalPrice  Int?
  image          String     @default("placeholder.svg")
  categoryId     Int
  rating         Float      @default(0)
  reviews        Int        @default(0)
  popular        Boolean    @default(false)
  quantity       Int
  cartItem       CartItem[]
  order          Order[]

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category     Category     @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([organizationId])
}

model Order {
  id             Int          @id @default(autoincrement())
  organizationId Int          @default(1)
  productId      Int
  studentId      Int
  quantity       Int          @default(1)
  status         OrderStatus  @default(PENDING)
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  product        Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([studentId])
  @@index([organizationId])
}

// 

enum AttendanceStatus {
  UNSPECIFIED
  PRESENT
  ABSENT
}

enum OrderStatus {
  COMPLETED
  PENDING
  CANCELLED
}

enum LessonStatus {
  ACTIVE
  CANCELLED
}

enum StudentStatus {
  TRIAL
  ACTIVE
  DISMISSED
}

enum StudentLessonsBalanceChangeReason {
  PAYMENT_CREATED
  PAYMENT_CANCELLED
  ATTENDANCE_PRESENT_CHARGED
  ATTENDANCE_ABSENT_CHARGED
  MAKEUP_ATTENDED_CHARGED
  ATTENDANCE_REVERTED
  MAKEUP_GRANTED
  MANUAL_SET
  TOTAL_PAYMENTS_MANUAL_SET
  TOTAL_LESSONS_MANUAL_SET
  BALANCE_REDISTRIBUTED
}

enum StudentFinancialField {
  LESSONS_BALANCE
  TOTAL_PAYMENTS
  TOTAL_LESSONS
}
